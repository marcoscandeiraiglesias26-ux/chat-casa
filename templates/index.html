<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaChat Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div id="chat-container">
        <div class="header">
            <input type="text" id="username" placeholder="Nombre..." maxlength="12">
            <select id="room-select">
                <option value="General">Sala General</option>
                <option value="Dudas">Dudas</option>
                <option value="Juegos">Juegos</option>
            </select>
            <span id="user-stats">ğŸ‘¥ 0</span>
        </div>

        <div class="actions">
            <button class="btn-clear" onclick="clearHistory()">ğŸ—‘ï¸ Limpiar chat local</button>
        </div>
        
        <div id="messages"></div>
        <div id="typing-indicator"></div>

        <div class="input-area">
            <label for="file-input" style="cursor:pointer; font-size: 22px;">ğŸ“</label>
            <input type="file" id="file-input" style="display:none;">
            <input type="text" id="myMessage" placeholder="Escribe un mensaje..." autocomplete="off">
            <button id="sendButton">â¤</button>
        </div>
    </div>

    <audio id="chatSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

    <script>
        const socket = io();
        const msgInput = document.getElementById('myMessage');
        const userInput = document.getElementById('username');
        const roomSelect = document.getElementById('room-select');
        const messagesDiv = document.getElementById('messages');
        const typingDiv = document.getElementById('typing-indicator');

        let currentRoom = roomSelect.value;

        function clearHistory() {
            if(confirm("Â¿Quieres limpiar los mensajes de tu pantalla?")) {
                messagesDiv.innerHTML = "";
            }
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 65%, 40%)`;
        }

        socket.on('message', (data) => {
            // Opacidad para mensajes anteriores
            messagesDiv.querySelectorAll('.message-bubble').forEach(m => m.style.opacity = "0.7");

            const p = document.createElement('div');
            const isMe = data.name === (userInput.value || "AnÃ³nimo");
            p.className = `message-bubble ${isMe ? 'my-message' : ''}`;
            
            let content = `<strong style="color:${stringToColor(data.name)}">${data.name}</strong>`;
            content += `<span>${data.text}</span>`;
            
            if (data.file) {
                if (data.fileType.startsWith('image/')) {
                    content += `<img src="${data.file}" style="max-width:100%; border-radius:5px; margin-top:5px; display:block;">`;
                } else {
                    content += `<a href="${data.file}" download="${data.fileName}" class="file-link">ğŸ“ ${data.fileName}</a>`;
                }
            }
            
            p.innerHTML = content;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if(!isMe) document.getElementById('chatSound').play();
        });

        // Eventos bÃ¡sicos (Join, Typing, etc.)
        roomSelect.onchange = () => { 
            messagesDiv.innerHTML = ""; 
            currentRoom = roomSelect.value; 
            socket.emit('join', {user: userInput.value || "AnÃ³nimo", room: currentRoom});
        };

        document.getElementById('sendButton').onclick = () => {
            if(msgInput.value.trim()){
                socket.emit('message', {name: userInput.value || "AnÃ³nimo", text: msgInput.value, room: currentRoom});
                msgInput.value = '';
            }
        };

        msgInput.onkeypress = (e) => { if(e.key === 'Enter') document.getElementById('sendButton').click(); };

        socket.on('update_users', (count) => { document.getElementById('user-stats').innerText = `ğŸ‘¥ ${count}`; });

        // Script de archivos (Igual que el anterior)
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file || file.size > 1024 * 1024) return alert("Archivo mÃ¡ximo 1MB");
            const reader = new FileReader();
            reader.onload = (evt) => {
                socket.emit('message', {name: userInput.value || "AnÃ³nimo", text: `ğŸ“ Archivo`, file: evt.target.result, fileName: file.name, fileType: file.type, room: currentRoom});
            };
            reader.readAsDataURL(file);
        };
        
        socket.emit('join', {user: userInput.value || "AnÃ³nimo", room: currentRoom});
    </script>
</body>
</html>
